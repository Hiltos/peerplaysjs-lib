!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).peerplays_ws=e()}}(function(){return function r(s,c,a){function u(t,e){if(!c[t]){if(!s[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(h)return h(t,!0);var i=new Error("Cannot find module '"+t+"'");throw i.code="MODULE_NOT_FOUND",i}var o=c[t]={exports:{}};s[t][0].call(o.exports,function(e){return u(s[t][1][e]||e)},o,o.exports,r,s,c,a)}return c[t].exports}for(var h="function"==typeof require&&require,e=0;e<a.length;e++)u(a[e]);return u}({1:[function(e,t,n){"use strict";n.__esModule=!0,n.Manager=n.ChainConfig=n.Apis=void 0;var i=s(e("./src/ApiInstances")),o=s(e("./src/ConnectionManager")),r=s(e("./src/ChainConfig"));function s(e){return e&&e.__esModule?e:{default:e}}n.Apis=i.default,n.ChainConfig=r.default,n.Manager=o.default},{"./src/ApiInstances":2,"./src/ChainConfig":3,"./src/ConnectionManager":5}],2:[function(e,t,n){"use strict";n.__esModule=!0;var i=s(e("./ChainWebSocket")),o=s(e("./GrapheneApi")),r=s(e("./ChainConfig"));function s(e){return e&&e.__esModule?e:{default:e}}var c=void 0,a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return e.prototype.connect=function(t,e){var n=this;if("undefined"!=typeof window&&window.location&&"https:"===window.location.protocol&&t.indexOf("wss://")<0)throw new Error("Secure domains require wss connection");this.ws_rpc=new i.default(t,this.statusCb,e),this.init_promise=this.ws_rpc.login("","").then(function(){console.log("Connected to API node:",t),n._db=new o.default(n.ws_rpc,"database"),n._net=new o.default(n.ws_rpc,"network_broadcast"),n._hist=new o.default(n.ws_rpc,"history"),n._crypt=new o.default(n.ws_rpc,"crypto"),n._bookie=new o.default(n.ws_rpc,"bookie");var e=n._db.init().then(function(){return n._db.exec("get_chain_id",[]).then(function(e){return n.chain_id=e,r.default.setChainId(e)})});return n.ws_rpc.on_reconnect=function(){n.ws_rpc.login("","").then(function(){n._db.init().then(function(){n.statusCb&&n.statusCb(i.default.status.RECONNECTED)}),n._net.init(),n._hist.init(),n._crypt.init(),n._bookie.init()})},Promise.all([e,n._net.init(),n._hist.init(),n._crypt.init().catch(function(e){return console.error("ApiInstance\tCrypto API Error",e)}),n._bookie.init()])})},e.prototype.close=function(){this.ws_rpc&&this.ws_rpc.close(),this.ws_rpc=null},e.prototype.db_api=function(){return this._db},e.prototype.network_api=function(){return this._net},e.prototype.history_api=function(){return this._hist},e.prototype.crypto_api=function(){return this._crypt},e.prototype.bookie_api=function(){return this._bookie},e.prototype.setRpcConnectionStatusCallback=function(e){this.statusCb=e},e}();n.default={setRpcConnectionStatusCallback:function(e){this.statusCb=e,c&&c.setRpcConnectionStatusCallback(e)},reset:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"ws://localhost:8090",t=arguments[1],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:4e3;return c&&(c.close(),c=null),(c=new a).setRpcConnectionStatusCallback(this.statusCb),c&&t&&c.connect(e,n),c},instance:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"ws://localhost:8090",t=arguments[1],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:4e3;return c||(c=new a).setRpcConnectionStatusCallback(this.statusCb),c&&t&&c.connect(e,n),c},chainId:function(){return this.instance().chain_id},close:function(){c&&(c.close(),c=null)}}},{"./ChainConfig":3,"./ChainWebSocket":4,"./GrapheneApi":6}],3:[function(e,t,n){(function(e){"use strict";n.__esModule=!0;var s={address_prefix:e.env.npm_config__graphene_ecc_default_address_prefix||"GPH"},c={core_asset:"CORE",address_prefix:"GPH",expire_in_secs:15,expire_in_secs_proposal:86400,review_in_secs_committee:86400,networks:{BitShares:{core_asset:"BTS",address_prefix:"BTS",chain_id:"4018d7844c78f6a6c41c6a552b898022310fc5dec06da467ee7905a8dad512c8"},Muse:{core_asset:"MUSE",address_prefix:"MUSE",chain_id:"45ad2d3f9ef92a49b55c2227eb06123f613bb35dd08bd876f2aea21925a67a67"},Test:{core_asset:"TEST",address_prefix:"TEST",chain_id:"39f5e2ede1f8bc1a3a54a7914414e3779e33193f1f5693510e73cb7a87617447"},Obelisk:{core_asset:"GOV",address_prefix:"FEW",chain_id:"1cfde7c388b9e8ac06462d68aadbd966b58f88797637d9af805b4560b0e9661e"},Peerplays:{core_asset:"PPY",address_prefix:"PPY",chain_id:"594e284d3c733afaaa34a5e99a39edb31e5192fab023101d691d952034902237"}},setChainId:function(e){for(var t=Object.keys(c.networks),n=0,i=t.length;n<i;n++){var o=t[n],r=c.networks[o];if(r.chain_id===e)return c.network_name=o,r.address_prefix&&(c.address_prefix=r.address_prefix,s.address_prefix=r.address_prefix),{network_name:o,network:r}}c.network_name||console.log("Unknown chain id (this may be a testnet)",e)},reset:function(){c.core_asset="CORE",c.address_prefix="GPH",s.address_prefix="GPH",c.expire_in_secs=15,c.expire_in_secs_proposal=86400,console.log("Chain config reset")},setPrefix:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"GPH";c.address_prefix=e,s.address_prefix=e}};n.default=c}).call(this,e("_process"))},{_process:8}],4:[function(e,t,n){"use strict";n.__esModule=!0;var o=null;o="undefined"!=typeof WebSocket?WebSocket:e("ws");var r=["set_subscribe_callback","subscribe_to_market","broadcast_transaction_with_callback","set_pending_transaction_callback"],s=["unsubscribe_from_market","unsubscribe_from_accounts"],i=function(){function i(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1e4;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),this.statusCb=t,this.serverAddress=e,this.timeoutInterval=n,this.connected=!1,this.reconnectTimeout=null,this.on_reconnect=null,this.cbId=0,this.cbs={},this.subs={},this.unsub={},this.currentResolve=null,this.currentReject=null,this.healthCheck=null,this.status=i.status,this.onConnectionOpen=this.onConnectionOpen.bind(this),this.onConnectionClose=this.onConnectionClose.bind(this),this.onConnectionTerminate=this.onConnectionTerminate.bind(this),this.onConnectionError=this.onConnectionError.bind(this),this.onConnectionTimeout=this.onConnectionTimeout.bind(this),this.createConnection=this.createConnection.bind(this),this.createConnectionPromise=this.createConnectionPromise.bind(this),this.listener=this.listener.bind(this),this.createConnection()}return i.prototype.createConnection=function(){this.debug("!!! ChainWebSocket create connection"),this.reconnectTimeout=null,this.connect_promise||(this.connect_promise=new Promise(this.createConnectionPromise));try{this.ws=new o(this.serverAddress)}catch(e){return this.resetConnection()}this.addEventListeners(),this.connectionTimeout=setTimeout(this.onConnectionTimeout,this.timeoutInterval)},i.prototype.resetConnection=function(){this.close(),this.reconnectTimeout||(this.debug("!!! ChainWebSocket reset connection",this.timeoutInterval),this.reconnectTimeout=setTimeout(this.createConnection,this.timeoutInterval)),this.currentReject&&this.currentReject(new Error("Connection attempt failed: "+this.serverAddress))},i.prototype.addEventListeners=function(){this.debug("!!! ChainWebSocket add event listeners"),this.ws.addEventListener("open",this.onConnectionOpen),this.ws.addEventListener("close",this.onConnectionClose),this.ws.addEventListener("error",this.onConnectionError),this.ws.addEventListener("message",this.listener)},i.prototype.removeEventListeners=function(){this.debug("!!! ChainWebSocket remove event listeners"),this.ws.removeEventListener("open",this.onConnectionOpen),this.ws.removeEventListener("close",this.onConnectionClose),this.ws.removeEventListener("error",this.onConnectionError),this.ws.removeEventListener("message",this.listener)},i.prototype.createConnectionPromise=function(e,t){this.debug("!!! ChainWebSocket createPromise"),this.currentResolve=e,this.currentReject=t},i.prototype.onConnectionOpen=function(){this.debug("!!! ChainWebSocket Connected "),this.connected=!0,clearTimeout(this.connectionTimeout),this.connectionTimeout=null,this.on_reconnect&&this.on_reconnect(),this.currentResolve&&this.currentResolve(),this.statusCb&&this.statusCb(i.status.OPEN)},i.prototype.onConnectionTimeout=function(){this.debug("!!! ChainWebSocket timeout"),this.onConnectionClose(new Error("Connection timed out."))},i.prototype.onConnectionTerminate=function(){this.debug("!!! ChainWebSocket terminate"),this.onConnectionClose(new Error("Connection was terminated."))},i.prototype.onConnectionClose=function(e){this.debug("!!! ChainWebSocket Close ",e),this.resetConnection(),this.statusCb&&this.statusCb(i.status.CLOSED)},i.prototype.onConnectionError=function(e){this.debug("!!! ChainWebSocket On Connection Error ",e),this.resetConnection(),this.statusCb&&this.statusCb(i.status.ERROR)},i.prototype.call=function(e){var n=this;if(!this.connected)return this.debug("!!! ChainWebSocket Call not connected. "),Promise.reject(new Error("Disconnected from the BlockChain."));this.debug("!!! ChainWebSocket Call connected. ",e);var i={method:e[1],params:e,id:this.cbId+1};if(this.cbId=i.id,r.includes(i.method)&&(this.subs[i.id]={callback:i.params[2][0]},i.params[2][0]=i.id),s.includes(i.method)){if("function"!=typeof i.params[2][0])throw new Error("First parameter of unsub must be the original callback");var t=i.params[2].splice(0,1)[0];for(var o in this.subs)if(this.subs[o].callback===t){this.unsub[i.id]=o;break}}return this.healthCheck||(this.healthCheck=setTimeout(this.onConnectionTerminate.bind(this),1e4)),new Promise(function(e,t){n.cbs[i.id]={time:new Date,resolve:e,reject:t},i.method="call";try{n.ws.send(JSON.stringify(i))}catch(e){n.debug("Caught a nasty error : ",e)}})},i.prototype.listener=function(t){var n=null;try{n=JSON.parse(t.data)}catch(e){n.error="Error parsing response: "+e.stack,this.debug("Error parsing response: ",t)}this.healthCheck&&(clearTimeout(this.healthCheck),this.healthCheck=null);var e=!1,i=null;"notice"===n.method&&(e=!0,n.id=n.params[0]),(i=e?this.subs[n.id].callback:this.cbs[n.id])&&!e?(n.error?(this.debug("----\x3e responseJSON : ",n),i.reject(n.error)):i.resolve(n.result),delete this.cbs[n.id],this.unsub[n.id]&&(delete this.subs[this.unsub[n.id]],delete this.unsub[n.id])):i&&e?i(n.params[1]):this.debug("Warning: unknown websocket responseJSON: ",n)},i.prototype.login=function(e,t){var n=this;return this.debug("!!! ChainWebSocket login.",e,t),this.connect_promise.then(function(){return n.call([1,"login",[e,t]])})},i.prototype.close=function(){this.ws&&(this.removeEventListeners(),this.ws.close(),this.ws=null),clearTimeout(this.connectionTimeout),this.connectionTimeout=null,clearTimeout(this.healthCheck),this.healthCheck=null,clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null,this.connected=!1},i.prototype.debug=function(){},i}();i.status={RECONNECTED:"reconnected",OPEN:"open",CLOSED:"closed",ERROR:"error"},n.default=i},{ws:7}],5:[function(e,t,n){"use strict";n.__esModule=!0;var o=i(e("./ApiInstances")),a=i(e("./ChainWebSocket"));function i(e){return e&&e.__esModule?e:{default:e}}var r=function(){function i(e){var t=e.url,n=e.urls;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),this.url=t,this.urls=n.filter(function(e){return e!==t})}return i.prototype.logFailure=function(e){console.error("Unable to connect to",e+", skipping to next full node API server")},i.prototype.connect=function(){var n=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.url;return new Promise(function(e,t){o.default.instance(i,n).init_promise.then(e).catch(function(e){o.default.instance().close(),t(e)})})},i.prototype.connectWithFallback=function(){var n=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.url,o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=this,e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,t=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;if(t&&o>this.urls.length-1)return t(new Error("Tried "+(o+1)+" connections, none of which worked: "+JSON.stringify(this.urls.concat(this.url))));var s=function(e,t){return r.logFailure(i),r.connectWithFallback(n,r.urls[o],o+1,e,t)};return e&&t?this.connect(n,i).then(e).catch(function(){s(e,t)}):new Promise(function(e,t){r.connect(n).then(e).catch(function(){s(e,t)})})},i.prototype.checkConnections=function(){var o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",s=this,e=arguments[2],t=arguments[3],c={},n=function(t,e){var n=s.urls.concat(s.url),i=[];n.forEach(function(t){var n=new a.default(t,function(){});c[t]=(new Date).getTime(),i.push(function(){return n.login(o,r).then(function(){var e;return n.close(),(e={})[t]=(new Date).getTime()-c[t],e}).catch(function(){return t===s.url?s.url=s.urls[0]:s.urls=s.urls.filter(function(e){return e!==t}),n.close(),null})})}),Promise.all(i.map(function(e){return e()})).then(function(e){t(e.filter(function(e){return!!e}).reduce(function(e,t){var n=Object.keys(t)[0];return e[n]=t[n],e},{}))}).catch(function(){return s.checkConnections(o,r,t,e)})};if(!e||!t)return new Promise(n);n(e,t)},i}();n.default=r},{"./ApiInstances":2,"./ChainWebSocket":4}],6:[function(e,t,n){"use strict";n.__esModule=!0;var i=function(){function n(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),this.ws_rpc=e,this.api_name=t}return n.prototype.init=function(){var t=this;return this.ws_rpc.call([1,this.api_name,[]]).then(function(e){return t.api_id=e,t})},n.prototype.exec=function(t,n){return this.ws_rpc.call([this.api_id,t,n]).catch(function(e){throw console.log("!!! GrapheneApi error: ",t,n,e,JSON.stringify(e)),e})},n}();n.default=i},{}],7:[function(e,t,n){},{}],8:[function(e,t,n){var i,o,r=t.exports={};function s(){throw new Error("setTimeout has not been defined")}function c(){throw new Error("clearTimeout has not been defined")}function a(t){if(i===setTimeout)return setTimeout(t,0);if((i===s||!i)&&setTimeout)return i=setTimeout,setTimeout(t,0);try{return i(t,0)}catch(e){try{return i.call(null,t,0)}catch(e){return i.call(this,t,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:s}catch(e){i=s}try{o="function"==typeof clearTimeout?clearTimeout:c}catch(e){o=c}}();var u,h=[],l=!1,f=-1;function d(){l&&u&&(l=!1,u.length?h=u.concat(h):f=-1,h.length&&p())}function p(){if(!l){var e=a(d);l=!0;for(var t=h.length;t;){for(u=h,h=[];++f<t;)u&&u[f].run();f=-1,t=h.length}u=null,l=!1,function(t){if(o===clearTimeout)return clearTimeout(t);if((o===c||!o)&&clearTimeout)return o=clearTimeout,clearTimeout(t);try{o(t)}catch(e){try{return o.call(null,t)}catch(e){return o.call(this,t)}}}(e)}}function b(e,t){this.fun=e,this.array=t}function _(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(1<arguments.length)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];h.push(new b(e,t)),1!==h.length||l||a(p)},b.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=_,r.addListener=_,r.once=_,r.off=_,r.removeListener=_,r.removeAllListeners=_,r.emit=_,r.prependListener=_,r.prependOnceListener=_,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},{}]},{},[1])(1)});